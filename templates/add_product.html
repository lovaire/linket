{% extends 'base.html' %}

{% block title %}Tambah Produk - Linket{% endblock %}

{% block extra_css %}
<style>
    #image-url-list {
        margin-top: 0.5rem;
    }
    .image-url-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .image-url-item input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .image-url-item button {
        padding: 0.4rem 0.6rem;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .image-url-item button:hover {
        background: #c0392b;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="form-container">
    <h2 class="form-title">Tambah Produk Afiliasi Baru</h2>

    <form method="post" id="product-form">
        {% csrf_token %}

        {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>

                {% if field.name == 'image_urls' %}
                    <!-- Area untuk input dinamis -->
                    <div id="image-url-list"></div>
                    <!-- Biarkan Django render field asli (akan disembunyikan) -->
                    {{ field }}
                {% else %}
                    {{ field }}
                {% endif %}

                {% if field.help_text %}
                    <small class="helptext">{{ field.help_text }}</small>
                {% endif %}
                {% if field.errors %}
                    <ul class="errorlist">
                        {% for error in field.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        {% endfor %}

        <button type="submit" class="btn btn-submit">Simpan Produk</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('image-url-list');
    const textarea = document.getElementById('id_image_urls');

    if (!container || !textarea) return;

    // Sembunyikan textarea asli
    textarea.style.display = 'none';

    // Buat input baru
    function addInput(url = '') {
        const div = document.createElement('div');
        div.className = 'image-url-item';
        div.innerHTML = `
            <input type="url" value="${url}" placeholder="https://contoh.com/gambar.jpg" style="flex:1; padding:6px; margin-right:6px; border:1px solid #ccc; border-radius:4px;">
            <button type="button" style="padding:6px 10px; background:#e74c3c; color:white; border:none; border-radius:4px; cursor:pointer;">Hapus</button>
        `;

        // Hapus item
        div.querySelector('button').onclick = () => {
            div.remove();
            syncToTextarea();
        };

        // Tambah input baru saat diisi
        const input = div.querySelector('input');
        input.oninput = () => {
            syncToTextarea();
            const inputs = container.querySelectorAll('input');
            const isLast = input === inputs[inputs.length - 1];
            if (isLast && input.value.trim() !== '') {
                addInput(); // tambah input baru
            }
        };

        container.appendChild(div);
    }

    // Sinkronkan ke textarea
    function syncToTextarea() {
        const urls = Array.from(container.querySelectorAll('input'))
            .map(el => el.value.trim())
            .filter(v => v);
        textarea.value = urls.join('\n');
    }

    // === INISIALISASI ===
    const saved = (textarea.value || '').split('\n').filter(v => v.trim());
    if (saved.length) {
        saved.forEach(url => addInput(url));
    } else {
        addInput(); // minimal 1 input
    }
});
</script>
{% endblock extra_js %}