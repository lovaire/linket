{% extends 'base.html' %}

{% block title %}Tambah Produk - Linket{% endblock %}

{% block extra_css %}
<style>
    #image-url-list {
        margin-top: 0.5rem;
    }
    .image-url-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .image-url-item input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .image-url-item button {
        padding: 0.4rem 0.6rem;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .image-url-item button:hover {
        background: #c0392b;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="form-container">
    <h2 class="form-title">Tambah Produk Afiliasi Baru</h2>

    <form method="post" id="product-form">
        {% csrf_token %}

        {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>

                {% if field.name == 'image_urls' %}
                    <div id="image-url-list"></div>
                    <!-- Penting: isi dengan field.value -->
                    <textarea name="{{ field.name }}" id="{{ field.id_for_label }}" style="display:none;">{{ field.value|default:"" }}</textarea>
                    {% if field.help_text %}
                        <small class="helptext">{{ field.help_text }}</small>
                    {% endif %}
                {% else %}
                    {{ field }}
                    {% if field.help_text %}
                        <small class="helptext">{{ field.help_text }}</small>
                    {% endif %}
                {% endif %}

                {% if field.errors %}
                    <ul class="errorlist">
                        {% for error in field.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        {% endfor %}

        <button type="submit" class="btn btn-submit">Simpan Produk</button>
    </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('image-url-list');
    const hiddenTextarea = document.getElementById('id_image_urls');
    const form = document.getElementById('product-form');

    if (!container || !hiddenTextarea) {
        console.error('❌ Elemen image_urls tidak ditemukan.');
        return;
    }

    // Fungsi untuk membuat input baru
    function createInput(url = '') {
        const div = document.createElement('div');
        div.className = 'image-url-item';

        const input = document.createElement('input');
        input.type = 'url';
        input.placeholder = 'https://contoh.com/gambar.jpg';
        input.value = url;

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Hapus';
        removeBtn.type = 'button';

        // Hapus item saat tombol diklik
        removeBtn.addEventListener('click', () => {
            div.remove();
            saveToTextarea();
        });

        // Saat input berubah, cek apakah perlu tambah input baru
        input.addEventListener('input', () => {
            saveToTextarea();
            // Jika ini input terakhir dan sudah diisi, tambah input baru
            const allInputs = container.querySelectorAll('input');
            const isLast = div === allInputs[allInputs.length - 1].closest('.image-url-item');
            if (isLast && input.value.trim() !== '') {
                createInput();
            }
        });

        div.appendChild(input);
        div.appendChild(removeBtn);
        container.appendChild(div);
    }

    // Simpan semua URL ke textarea tersembunyi
    function saveToTextarea() {
        const urls = Array.from(container.querySelectorAll('input'))
            .map(el => el.value.trim())
            .filter(val => val !== '');
        hiddenTextarea.value = urls.join('\n');
    }

    // === INISIALISASI ===
    // Baca nilai awal dari textarea (misal saat edit)
    const initialUrls = (hiddenTextarea.value || '')
        .split('\n')
        .map(s => s.trim())
        .filter(s => s);

    // Render input berdasarkan data awal
    if (initialUrls.length > 0) {
        initialUrls.forEach(url => createInput(url));
    }

    // Jika tidak ada data, buat satu input kosong
    if (initialUrls.length === 0) {
        createInput();
    }

    // Pastikan textarea terupdate saat submit
    if (form) {
        form.addEventListener('submit', saveToTextarea);
    }
});
</script>
{% endblock extra_js %}